<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Калькулятор податків ФОП</title>
    <style>
        :root{ --bg:#0f1115; --panel:#171a21; --muted:#8a93a6; --text:#eef1f7;
          --accent:#6ea8fe; --ok:#52d273; --warn:#ffb020; --bad:#ff6b6b; --line:#232635; --chip:#1f2330; }
        *{box-sizing:border-box}
        body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
          color:var(--text); background:linear-gradient(180deg,#0c0f14,#0f1115 30%,#0f1115); padding:24px; }
        h1{margin:0 0 12px;font-size:24px}
        .app{max-width:1100px;margin:0 auto;display:grid;gap:16px;grid-template-columns:1.2fr 1fr}
        @media (max-width:980px){.app{grid-template-columns:1fr}}
        .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:16px 16px 10px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
        .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
        .row-3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
        .row-4{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr 1fr}
        @media (max-width:760px){.row,.row-3,.row-4{grid-template-columns:1fr}}
        label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
        input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);background:#0e1118;color:var(--text);outline:none}
        input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(110,168,254,.15)}
        .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--text);border:1px solid var(--line);font-size:13px}
        .chips{display:flex;flex-wrap:wrap;gap:8px}
        .rate-up{color:var(--ok)} .rate-down{color:var(--bad)} .muted{color:var(--muted)}
        .total{display:grid;gap:12px;grid-template-columns:1fr 1fr;align-items:stretch}
        @media (max-width:760px){.total{grid-template-columns:1fr}}
        .kpi{background:#0e1118;border:1px solid var(--line);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:6px;justify-content:center}
        .kpi .v{font-size:28px;font-weight:700}
        .kpi small{color:var(--muted)}
        .hr{height:1px;background:var(--line);margin:12px 0}
        .hint{font-size:12px;color:var(--muted)}
        .grid{display:grid;gap:12px}
        .section-title{font-weight:700;margin-bottom:2px}
        .footer-note{font-size:12px;color:var(--muted);margin-top:8px}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#10131b;color:var(--text);cursor:pointer;user-select:none}
        .btn:active{transform:translateY(1px)}
        .btn[disabled], select[disabled]{opacity:.5;cursor:not-allowed;filter:grayscale(.2)}
        .right{display:flex;gap:10px;justify-content:flex-end}

        /* monthly UI */
        .months-header{display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap}
        .switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--text);cursor:pointer}
        .switch input{appearance:none;width:40px;height:22px;border-radius:999px;background:#0e1118;border:1px solid var(--line);position:relative;outline:none}
        .switch input:after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#2a2f3d;border-radius:50%;transition:transform .2s}
        .switch input:checked{border-color:var(--accent)}
        .switch input:checked:after{transform:translateX(18px);background:var(--accent)}
        .months-list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
        .salary-item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center}
        .salary-item .idx{font-size:12px;color:var(--muted)}
        .icon-btn{background:#0e1118;border:1px solid var(--line);border-radius:10px;padding:10px;cursor:pointer}
        .icon-btn:active{transform:translateY(1px)}
        .delete-btn{border-color:#3a1e22;background:#151014;color:#ff8b8b}
        .delete-btn:hover{border-color:#ff6b6b;color:#ffd1d1}
        .months-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
        .sum-chip{margin-top:4px}
        .sum-chip .chip{max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .hide{display:none}

        /* number spinners off */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none;margin:0 }
        input[type=number]{ -moz-appearance:textfield }

        /* KPI long values */
        .kpi .v{display:block;width:100%;font-size:clamp(18px,3vw,28px);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .kpi .v.shrink{font-size:clamp(16px,2.4vw,22px)}
    </style>
</head>
<body>
<h1>Калькулятор податків ФОП</h1>
<div class="app">
    <!-- LEFT -->
    <div class="card">
        <div class="row">
            <div>
                <label>Група ФОП</label>
                <select id="group">
                    <option value="1">1 група</option>
                    <option value="2">2 група</option>
                    <option value="3" selected>3 група</option>
                    <option value="general">Загальна система</option>
                </select>
            </div>
            <div>
                <label>Період розрахунку</label>
                <select id="period">
                    <option value="month" selected>Місяць</option>
                    <option value="quarter">Квартал</option>
                    <option value="year">Рік</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div>
                <label>Дохід за період (UAH)</label>
                <input id="incomeUAH" type="number" min="0" step="0.01" value="100000"/>
            </div>
            <div>
                <label>Валюта вводу доходу</label>
                <select id="incomeCurrency">
                    <option value="UAH" selected>UAH</option>
                    <option value="USD">USD</option>
                </select>
            </div>
        </div>

        <!-- Monthly (optional) -->
        <div class="hr"></div>
        <div class="section-title">Помісячний ввід (опціонально)</div>
        <div class="months-header">
            <label class="switch">
                <input type="checkbox" id="useMonthly">
                Увімкнути помісячний ввід доходу
            </label>
            <div class="months-toolbar">
                <div>
                    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px">Валюта помісячних
                        сум</label>
                    <select id="monthlyCurrency">
                        <option value="UAH" selected>UAH</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
                <button class="btn" id="addMonthBtn">+ Додати місяць</button>
                <button class="btn" id="clearMonthsBtn">Очистити</button>
            </div>
        </div>
        <div id="monthsHint" class="hint">У цьому режимі поле “Дохід за період” та “Валюта вводу доходу” ігноруються —
            сума береться як Σ введених місяців у вибраній валюті і конвертується в UAH за курсом НБУ.
        </div>
        <div id="monthsList" class="months-list"></div>
        <div class="chips sum-chip" id="monthsSumWrap" style="margin-top:6px;"></div>

        <div class="hr"></div>
        <div class="section-title">Єдиний податок (ЄП)</div>
        <div class="row">
            <div>
                <label>Режим ЄП</label>
                <select id="epMode">
                    <option value="percent" selected>Відсоток від доходу</option>
                    <option value="fixed">Фіксована сума</option>
                </select>
            </div>
            <div>
                <label>Ставка ЄП (%) або сума (UAH)</label>
                <input id="epValue" type="number" min="0" step="0.01" value="5"/>
            </div>
        </div>

        <div class="hr"></div>
        <div class="section-title">Єдиний соціальний внесок (ЄСВ)</div>
        <div class="row">
            <div>
                <label>ЄСВ за 1 місяць (UAH)</label>
                <input id="esvPerMonth" type="number" min="0" step="0.01" value="1870.38"/>
                <div class="hint">Поле редаговане: за потреби постав мінімальний/потрібний рівень.</div>
            </div>
            <div>
                <label>К-ть місяців у періоді</label>
                <input id="monthsCount" type="number" min="1" max="12" step="1" value="1"/>
                <div class="hint" id="monthsAutoNote"></div>
            </div>
        </div>

        <div class="hr"></div>
        <div class="section-title">Військовий збір (ВЗ)</div>
        <div class="row">
            <div>
                <label>Ставка військового збору (%)</label>
                <input id="militaryTax" type="number" min="0" step="0.1" value="1"/>
            </div>
            <div>
                <label>Дохід для нарахування (UAH)</label>
                <input id="militaryBase" type="number" min="0" step="0.01"
                       placeholder="якщо пусто, береться увесь дохід"/>
                <div class="hint">Залиш порожнім, якщо застосовується до всього доходу</div>
            </div>
        </div>

        <div class="hr"></div>
        <div class="section-title">Інші нарахування</div>
        <div class="row-3">
            <div>
                <label>Інший податок (%)</label>
                <input id="otherPercent" type="number" min="0" step="0.01" value="0"/>
                <div class="hint">Напр., ПДФО тощо — якщо застосовні.</div>
            </div>
            <div>
                <label>Фіксована доплата (UAH)</label>
                <input id="otherFixed" type="number" min="0" step="0.01" value="0"/>
            </div>
            <div>
                <label>Комісії/банківські витрати (UAH)</label>
                <input id="feesUAH" type="number" min="0" step="0.01" value="0"/>
            </div>
        </div>

        <div class="hr"></div>
        <div class="right">
            <button class="btn" id="resetBtn">Скинути поля</button>
            <button class="btn" id="recalcBtn">Перерахувати</button>
        </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
        <div class="section-title">Курс НБУ (USD/UAH)</div>
        <div class="chips" id="rateChips">
            <span class="chip">Завантаження курсу…</span>
        </div>

        <div class="hr"></div>
        <div class="total">
            <div class="kpi">
                <small>Загальні податки (USD)</small>
                <div class="v" id="totalUSD">—</div>
                <small class="muted" id="usdNote"></small>
            </div>
            <div class="kpi">
                <small>Загальні податки (UAH)</small>
                <div class="v" id="totalUAH">—</div>
                <small class="muted" id="uahNote"></small>
            </div>
        </div>

        <div class="hr"></div>
        <div class="grid">
            <div class="section-title">Деталі розрахунку</div>
            <div class="row-3">
                <div class="kpi">
                    <small>ЄП</small>
                    <div class="v" id="epUAH">—</div>
                    <small class="muted" id="epModeNote"></small>
                </div>
                <div class="kpi">
                    <small>ЄСВ</small>
                    <div class="v" id="esvUAH">—</div>
                    <small class="muted" id="esvNote"></small>
                </div>
                <div class="kpi">
                    <small>ВЗ</small>
                    <div class="v" id="vzUAH">—</div>
                    <small class="muted" id="vzNote"></small>
                </div>
                <div class="kpi">
                    <small>Інше</small>
                    <div class="v" id="otherUAH">—</div>
                    <small class="muted" id="otherNote"></small>
                </div>
            </div>
        </div>

        <div class="footer-note">
            ⚠️ Ставки і правила часто змінюються. Калькулятор свідомо дає можливість редагувати всі поля та
            підлаштовувати під твій кейс (місто, рішення місцевої ради, режим 3%+ПДВ/5%, особливі умови тощо).
        </div>
    </div>
</div>

<script>
    // === Utils ===
    // Максимальні річні ліміти ФОП (2025)
      const FOP_LIMITS = {
        "1": 1182400,   // грн (1 група)
        "2": 7818900/1.35, // ≈5,8 млн грн (2 група)
        "3": 7818900,   // грн (3 група)
        "general": Infinity // без ліміту для загальної системи
      };

      // отримати ліміт для поточної групи
      function getFopLimit() {
        return FOP_LIMITS[groupEl.value] || Infinity;
      }

    const $ = (id) => document.getElementById(id);
    const fmtUAH = (v) => Number(v||0).toLocaleString('uk-UA',{style:'currency',currency:'UAH',maximumFractionDigits:2});
    const fmtUSD = (v) => Number(v||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2});
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    // Полные форматтеры
    const fmtUAHFull = (v) => Number(v||0).toLocaleString('uk-UA',{style:'currency',currency:'UAH',maximumFractionDigits:2});
    const fmtUSDFull = (v) => Number(v||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2});

    // Надёжный компакт: сначала пробуем currency+compact, если получилось длинно — делаем decimal+ручной символ
    function compactCurrency(locale, currency, value){
      const num = Number(value)||0;
      const full = new Intl.NumberFormat(locale,{style:'currency',currency,maximumFractionDigits:2}).format(num);
      let tryCompact = new Intl.NumberFormat(locale,{style:'currency',currency,notation:'compact',maximumFractionDigits:2}).format(num);
      // если compact "не сработал" (слишком длинно), делаем свою сборку
      if(tryCompact.length > 18){
        const dec = new Intl.NumberFormat(locale,{notation:'compact',maximumFractionDigits:2}).format(num);
        if(currency==='UAH'){
          tryCompact = `${dec} грн`; // в украинской локали валюта после числа
        }else if(currency==='USD'){
          const parts = new Intl.NumberFormat(locale,{style:'currency',currency, currencyDisplay:'narrowSymbol'}).formatToParts(1);
          const sym = (parts.find(p=>p.type==='currency')||{}).value || '$';
          tryCompact = `${sym}${dec}`;
        }else{
          tryCompact = `${dec} ${currency}`;
        }
      }
      return {full, compact:tryCompact};
    }

    // Порог для принудительного compact
    const FORCE_COMPACT_ABS = 1e4;
    const FORCE_COMPACT_LEN = 14;

    // KPI: показать деньги с автокомпактом
    function setMoney(el, value, currency='UAH') {
      const locale = currency==='USD' ? 'en-US' : 'uk-UA';
      const {full, compact} = compactCurrency(locale, currency, value);
      const mustCompact = Math.abs(Number(value)||0) >= FORCE_COMPACT_ABS || String(full).length > FORCE_COMPACT_LEN;
      el.textContent = mustCompact ? compact : full;
      el.title = full;
      el.classList.toggle('shrink', mustCompact);
      if(!mustCompact){
        requestAnimationFrame(()=>{ if(el.scrollWidth>el.clientWidth){ el.textContent=compact; el.classList.add('shrink'); } });
      }
    }

    // Чипы «Σ помісячно»
    function chipMoney(value, currency='UAH'){
      const locale = currency==='USD' ? 'en-US' : 'uk-UA';
      const {full, compact} = compactCurrency(locale, currency, value);
      const mustCompact = Math.abs(Number(value)||0) >= FORCE_COMPACT_ABS || String(full).length > FORCE_COMPACT_LEN;
      return { text: mustCompact ? compact : full, title: full };
    }

    // === Elements ===
    const groupEl = $('group');
    const periodEl = $('period');
    const incomeUAHEl = $('incomeUAH');
    const incomeCurrencyEl = $('incomeCurrency');
    const epModeEl = $('epMode');
    const epValueEl = $('epValue');
    const esvPerMonthEl = $('esvPerMonth');
    const monthsCountEl = $('monthsCount');
    const otherPercentEl = $('otherPercent');
    const otherFixedEl = $('otherFixed');
    const feesUAHEl = $('feesUAH');
    const militaryTaxEl  = $('militaryTax');
    const militaryBaseEl = $('militaryBase');

    const totalUSDEl = $('totalUSD');
    const totalUAHEl = $('totalUAH');
    const usdNoteEl = $('usdNote');
    const uahNoteEl = $('uahNote');
    const epUAHEl = $('epUAH');
    const esvUAHEl = $('esvUAH');
    const otherUAHEl = $('otherUAH');
    const epModeNoteEl = $('epModeNote');
    const esvNoteEl = $('esvNote');
    const otherNoteEl = $('otherNote');
    const vzUAHEl = $('vzUAH');
    const vzNoteEl = $('vzNote');
    const rateChipsEl = $('rateChips');

    const recalcBtn = $('recalcBtn');
    const resetBtn = $('resetBtn');

    // Monthly UI
    const useMonthlyEl      = $('useMonthly');
    const addMonthBtn       = $('addMonthBtn');
    const clearMonthsBtn    = $('clearMonthsBtn');
    const monthsListEl      = $('monthsList');
    const monthsSumWrapEl   = $('monthsSumWrap');
    const monthsHintEl      = $('monthsHint');
    const monthsAutoNoteEl  = $('monthsAutoNote');
    const monthlyCurrencyEl = $('monthlyCurrency');

    // === NBU FX Rate ===
    async function fetchNbuUsd(dateStr){
      const base='https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?valcode=USD&json';
      const url = dateStr ? `${base}&date=${dateStr}` : base;
      const r = await fetch(url);
      if(!r.ok) throw new Error('NBU rate fetch failed');
      const data = await r.json();
      if(!Array.isArray(data)||!data.length) throw new Error('NBU rate empty');
      return { rate:data[0].rate, exchangedate:data[0].exchangedate };
    }
    function yyyymmdd(d){
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
      return `${y}${m}${day}`;
    }

    let fx = { today:null, prev:null };

    async function loadRates(){
      rateChipsEl.innerHTML = `<span class="chip">Завантаження курсу…</span>`;
      try{
        const now=new Date(); const yesterday=new Date(now); yesterday.setDate(now.getDate()-1);
        const [today,prev]=await Promise.all([fetchNbuUsd(), fetchNbuUsd(yyyymmdd(yesterday))]);
        fx.today=today; fx.prev=prev;
        const delta=today.rate - prev.rate;
        const dirClass= delta>0?'rate-up':(delta<0?'rate-down':''); const arrow= delta>0?'↑':(delta<0?'↓':'→');
        const deltaAbs=Math.abs(delta).toFixed(3);
        rateChipsEl.innerHTML = `
          <span class="chip"><strong>Сьогодні:</strong> ${today.rate.toFixed(3)} UAH</span>
          <span class="chip">Дата: ${today.exchangedate}</span>
          <span class="chip ${dirClass}">${arrow} зміна: ${deltaAbs}</span>
          <span class="chip muted">Вчора: ${prev.rate.toFixed(3)} UAH (${prev.exchangedate})</span>
        `;
      }catch(e){
        rateChipsEl.innerHTML = `<span class="chip" style="color:#ffb020">Не вдалося отримати курс НБУ. Перевір підключення.</span>`;
      }
      recalc();
    }

    // === Group presets ===
    let userEditedMonths=false;
    monthsCountEl.addEventListener('input',()=>{ userEditedMonths=true; });
    periodEl.addEventListener('change',()=>{ userEditedMonths=false; });

    function applyGroupHints(){
      const g=groupEl.value, p=periodEl.value;

      if(g==='3'){
        epModeEl.value='percent';
        if(Number(epValueEl.value)===5 || Number(epValueEl.value)===0) epValueEl.value=5;
      } else if(g==='1'||g==='2'){
        epModeEl.value='fixed';
        if(Number(epValueEl.value)===5) epValueEl.value=0;
      } else if(g==='general'){
        epModeEl.value='percent';
        if(Number(epValueEl.value)===5) epValueEl.value=0;
      }

      if(!userEditedMonths){
        if(p==='month')   monthsCountEl.value=1;
        if(p==='quarter') monthsCountEl.value=3;
        if(p==='year')    monthsCountEl.value=12;
      }
    }

    // === Monthly salaries state ===
    let salaries = []; // [{id, amount}]
    let idSeq = 1;

    function addSalary(amount=''){
      salaries.push({ id: idSeq++, amount: amount!=='' ? Number(amount) : '' });
      renderMonths();
      recalc();
    }
    function removeSalary(id){
      salaries = salaries.filter(x=>x.id!==id);
      renderMonths();
      recalc();
    }
    function setSalary(id, amount){
      const row = salaries.find(x=>x.id===id);
      if(row){
        let val = amount===''? '' : Number(amount);
        const max = getFopLimit();
        if(val > max){
          val = max; // обрезаем до максимума
          alert(`⚠️ Перевищено ліміт для ФОП (${max.toLocaleString('uk-UA')} грн). Значення скориговане.`);
        }
        row.amount = val;
      }
      renderSumChip();
      recalc();
}

    function monthlyRawSum(){
      return salaries.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    }
    function monthlySumUAH(){
      const raw = monthlyRawSum();
      if(monthlyCurrencyEl.value==='UAH') return raw;
      if(fx.today?.rate){ return raw * fx.today.rate; }
      return 0;
    }

    function renderMonths(){
      monthsListEl.innerHTML = salaries.map((x, idx)=>`
        <div class="salary-item" data-id="${x.id}">
          <div class="idx">Місяць ${idx+1}</div>
          <input type="number" step="0.01" min="0" placeholder="Сума за місяць" value="${x.amount!==''?x.amount:''}">
          <button class="icon-btn delete-btn" title="Видалити місяць" aria-label="Видалити місяць">✖</button>
        </div>
      `).join('');

      [...monthsListEl.querySelectorAll('.salary-item')].forEach(el=>{
        const id = Number(el.getAttribute('data-id'));
        const input = el.querySelector('input');
        const delBtn = el.querySelector('button');
        input.addEventListener('input', e=> setSalary(id, e.target.value));
        delBtn.addEventListener('click', ()=> removeSalary(id));
      });

      renderSumChip();
      toggleMonthlyUI();
      if(useMonthlyEl.checked && !userEditedMonths){
        monthsCountEl.value = Math.max(1, salaries.length||1);
        monthsAutoNoteEl.textContent = `Авто: дорівнює кількості введених місяців (${monthsCountEl.value}).`;
      } else {
        monthsAutoNoteEl.textContent = '';
      }
    }

    function renderSumChip(){
      if(!useMonthlyEl.checked){ monthsSumWrapEl.innerHTML=''; return; }
      const raw = monthlyRawSum();
      const rawFmt = chipMoney(raw, monthlyCurrencyEl.value);
      const sumUAH = monthlySumUAH();
      const hasRate = Boolean(fx.today?.rate);

      const extra = monthlyCurrencyEl.value==='USD'
        ? (hasRate
            ? (() => {
                const uahFmt = chipMoney(sumUAH, 'UAH');
                return `<span class="chip muted" title="${uahFmt.title}">≈ ${uahFmt.text} (за курсом НБУ)</span>`;
              })()
            : `<span class="chip" style="color:#ffb020">Курс НБУ не завантажено — конвертація в UAH недоступна</span>`)
        : '';

      monthsSumWrapEl.innerHTML = `
        <span class="chip" title="${rawFmt.title}"><strong>Σ помісячно:</strong>&nbsp;${rawFmt.text}</span>
        ${extra}
        <span class="chip muted">К-ть записів: ${salaries.length||0}</span>
      `;
    }

    function toggleMonthlyUI(){
      const active = useMonthlyEl.checked;
      monthsListEl.classList.toggle('hide', !active);
      monthsHintEl.classList.toggle('hide', !active);
      monthsSumWrapEl.classList.toggle('hide', !active);
      monthlyCurrencyEl.disabled = !active;
      addMonthBtn.disabled = !active;
      clearMonthsBtn.disabled = !active;
    }

    // === Calc ===
    function getIncomeUAH(){
      if(useMonthlyEl.checked && salaries.length>0){ return monthlySumUAH(); }
      const income = Number(incomeUAHEl.value)||0;
      if(incomeCurrencyEl.value==='USD' && fx.today?.rate){ return income*fx.today.rate; }
      return income;
    }

    function calc(){
      applyGroupHints();

      const incomeUAH = getIncomeUAH();
      const otherPercent = Number(otherPercentEl.value)||0;
      const otherFixed   = Number(otherFixedEl.value)||0;
      const feesUAH      = Number(feesUAHEl.value)||0;
      const months       = clamp(Number(monthsCountEl.value)||1, 1, 12);

      // EP
      let epUAH=0;
      if(epModeEl.value==='percent'){
        const ratePct = Number(epValueEl.value)||0;
        epUAH = incomeUAH * ratePct / 100;
        epModeNoteEl.textContent = `ЄП = ${ratePct}% від доходу`;
      }else{
        const fixed = Number(epValueEl.value)||0;
        epUAH = fixed * months;
        epModeNoteEl.textContent = `ЄП = фіксована сума × ${months} міс.`;
      }

      // Military tax
      const militaryRate = Number(militaryTaxEl.value)||0;
      const baseInput    = Number(militaryBaseEl.value);
      const base         = Number.isFinite(baseInput) && baseInput>0 ? baseInput : incomeUAH;
      const militaryUAH  = base * militaryRate / 100;
      vzNoteEl.textContent = militaryRate>0 ? `ВЗ = ${militaryRate}% від ${fmtUAH(base)}` : '—';

      // ESV
      const esvPerMonth = Number(esvPerMonthEl.value)||0;
      const esvUAH = esvPerMonth * months;
      esvNoteEl.textContent = `ЄСВ = ${fmtUAH(esvPerMonth)} × ${months} міс.`;

      // Other
      const otherFromPercent = incomeUAH * otherPercent / 100;
      const otherUAH = otherFromPercent + otherFixed + feesUAH;
      const otherParts=[];
      if(otherPercent>0) otherParts.push(`${otherPercent}% від доходу`);
      if(otherFixed>0)   otherParts.push(`фіксовано ${fmtUAH(otherFixed)}`);
      if(feesUAH>0)      otherParts.push(`комісії ${fmtUAH(feesUAH)}`);
      otherNoteEl.textContent = otherParts.length ? otherParts.join(' + ') : '—';

      const totalUAH = epUAH + esvUAH + otherUAH + militaryUAH;
      const usdRate  = fx.today?.rate || null;
      const totalUSD = usdRate ? (totalUAH / usdRate) : null;

      return { incomeUAH, epUAH, esvUAH, otherUAH, militaryUAH, totalUAH, totalUSD, usdRate };
    }

    function recalc(){
      const r = calc();
      setMoney(epUAHEl,    r.epUAH,       'UAH');
      setMoney(esvUAHEl,   r.esvUAH,      'UAH');
      setMoney(vzUAHEl,    r.militaryUAH, 'UAH');
      setMoney(otherUAHEl, r.otherUAH,    'UAH');

      setMoney(totalUAHEl, r.totalUAH,    'UAH');
      uahNoteEl.textContent = `За курсом НБУ буде перераховано у USD для довідки.`;

      if(r.totalUSD!=null){
        setMoney(totalUSDEl, r.totalUSD,  'USD');
        usdNoteEl.textContent  = `Курс: ${r.usdRate?.toFixed(3)} UAH за 1 USD (НБУ)`;
      }else{
        totalUSDEl.textContent='—';
        usdNoteEl.textContent = `Немає курсу — перевір підключення.`;
      }
      renderSumChip();
    }

    // === Events ===
    [
      groupEl, periodEl, incomeUAHEl, incomeCurrencyEl, epModeEl, epValueEl,
      esvPerMonthEl, monthsCountEl, otherPercentEl, otherFixedEl, feesUAHEl,
      militaryTaxEl, militaryBaseEl
    ].forEach(el => el.addEventListener('input', recalc));

    recalcBtn.addEventListener('click', recalc);
    resetBtn.addEventListener('click', ()=>{
      groupEl.value='3';
      periodEl.value='month';
      incomeUAHEl.value=100000;
      incomeCurrencyEl.value='UAH';
      epModeEl.value='percent';
      epValueEl.value=5;
      esvPerMonthEl.value=1870.38;
      monthsCountEl.value=1;
      otherPercentEl.value=0;
      otherFixedEl.value=0;
      feesUAHEl.value=0;
      militaryTaxEl.value=1;
      militaryBaseEl.value='';

      useMonthlyEl.checked=false;
      monthlyCurrencyEl.value='UAH';
      salaries = [];
      idSeq = 1;
      renderMonths();

      userEditedMonths=false;
      recalc();
    });

    useMonthlyEl.addEventListener('change', ()=>{
      toggleMonthlyUI();
      if(useMonthlyEl.checked && salaries.length===0) addSalary('');
      recalc();
    });
    addMonthBtn.addEventListener('click', ()=> addSalary(''));
    clearMonthsBtn.addEventListener('click', ()=>{
      salaries = [];
      renderMonths();
      recalc();
    });
    monthlyCurrencyEl.addEventListener('change', ()=>{
      renderSumChip();
      recalc();
    });

    renderMonths();
    toggleMonthlyUI();
    loadRates();
</script>
</body>
</html>
